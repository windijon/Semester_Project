---
title: "Johannes_Test_Area"
output: html_document
---


### Load the necessary libraries.

```{r message = FALSE, warning=FALSE}

library(devtools)
library(ComputationalMovementAnalysisData)
library(ggplot2)
library(readr)
library(dplyr)
library(terra)
library(sf)
library(tmap)
library(SimilarityMeasures)
library(lubridate)
library(tibble)

```


### Import the Data.

```{r message = FALSE, warning=FALSE}
install_github("ComputationalMovementAnalysis/ComputationalMovementAnalysisData")
```


```{r message = FALSE, warning=FALSE}
head(wildschwein_BE)
head(wildschwein_metadata)
head(wildschwein_overlap_temp)

view((wildschwein_overlap_temp))

write.csv(wildschwein_BE, file = "wildschwein_BE.csv")
write.csv(wildschwein_metadata, file = "wildschwein_metadata.csv")
write.csv(wildschwein_overlap_temp, file = "wildschwein_overlap_temp.csv")
write.csv(schreck_agenda, file = "schreck_agenda.csv")
write.csv(schreck_locations, file = "schreck_locations.csv")

```


```{r}

ws <- read.csv("wildschwein_BE.csv")


# Combining Cords
ws_be_sf <- st_as_sf(ws, coords = c("E", "N"), crs = 2056, remove = FALSE)

fritz <- st_as_sf(fritz, coords = c("E", "N"), crs = 2056, remove = FALSE)


```



Producing charts to anlyse sampling intervals
```{r}
library(ComputationalMovementAnalysisData)
library(ggplot2)
library(dplyr)
library(forcats)

limits <- c(0,200)
breaks = seq(0,200,50)
labels = paste(c(rep("",length(breaks)-1),">"), breaks)

ws %>%
  mutate(TierName = fct_reorder(TierName, DatetimeUTC,min, .desc = TRUE)) %>%
  group_by(TierID, TierName, CollarID) %>%
  mutate(
    timelag = as.numeric(difftime(lead(DatetimeUTC),DatetimeUTC, units = "mins")),
    ) %>%
  ggplot(aes(DatetimeUTC, TierName, colour = timelag)) +
  geom_line(lwd = 10) +
  scale_color_gradientn(name = "Sampling interval", colours = RColorBrewer::brewer.pal(11, "Spectral"), limits = limits, na.value = NA, oob = scales::squish, breaks = seq(0,200,50), labels = labels) +
  theme_minimal() +
  theme(legend.position = "top") +
  guides(color = guide_colorbar(title.position = "top", title.hjust = .5, barwidth = unit(20, "lines"), barheight = unit(.5, "lines")))
```



visualizing all Datapoints
```{r}
ggplot(fritz, aes(E, N, colour = moonilumination)) +
  geom_point() + theme_void()

```

Further anlysing --> pings, total tracking time etc.
```{r}
ws_be_sf %>% 
  st_drop_geometry() %>% 
  group_by(TierID, TierName) %>% 
  summarise(pings = n(),
            start_time = min(DatetimeUTC), 
            end_time = max(DatetimeUTC),
            avg_interval = mean(timelag, na.rm = T),
            total_tracking_time = sum(timelag, na.rm = T)) %>% 
  mutate(tracking_time_days = days(day(seconds_to_period(total_tracking_time)))) 
```


further analysing: by deriving overlap timing: interesting because we want to look for comparable snippets of data:

--> similar pings / sampling rate
--> similar time period
```{r}
sampling_periods <- ws_be_sf %>%
  group_by(TierID, TierName, CollarID) %>%
  summarise(
    min = min(DatetimeUTC),
    max = max(DatetimeUTC)
  )

sampling_periods


wildschwein_overlap_temp <- wildschwein_overlap_temp %>%
  left_join(sampling_periods, by = c("TierID", "TierName", "CollarID"))


wildschwein_overlap_temp %>%
mutate(TierCollar = paste(TierName, CollarID)) %>%
  ggplot(aes(xmin = min, xmax = max, y = TierCollar)) +
  geom_errorbarh() +
  facet_grid(Groups~., scales = "free_y", space = "free_y")
```

--> search for fitting // comparable // high interval of sampling 
-----------------------------------------------------


loading needed libraries 
```{r}

# Include tables with the function "kable"

knitr::kable(head(wildschwein_BE))
```



Spliting wildboar data in wildboar individuals 
Reason all are being tracked in the same time period: around 2015-01
```{r}
library(tidyverse)
ws_be_sf %>% filter(TierName == "Sabine") -> sabine
ws_be_sf %>% filter(TierName == "Nicole") -> nicole
ws_be_sf %>% filter(TierName == "Caroline") -> caroline
ws_be_sf %>% filter(TierName == "Isabelle") -> isabelle
ws_be_sf %>% filter(TierName == "Rosa") -> rosa
ws_be_sf %>% filter(TierName == "Ruth") -> ruth
ws_newyear_speed %>% filter(TierName == "Fritz") -> fritz

view(fritz)


inner_join(sabine, nicole, caroline, isabelle, rosa, ruth, fritz, by = "dt_rounded", suffix = c("_sabi", "_rosa")) %>% 
      mutate(distance = sqrt((E_sabi - E_rosa)^2 + (N_sabi - N_rosa)^2),
           meet = distance < 100) -> ws_join
```



# Task 2: Annotate Trajectories
Filter to winter
```{r}
ws_be_sf %>% 
  filter(DatetimeUTC >= as.Date("2014-12-15") & DatetimeUTC < as.Date("2015-01-015")) -> ws_newyear

ws_newyear <- as.numeric(ws_newyear(DatetimeUTC))

#date time rounden 

ws_newyear <- ws_newyear %>%
  group_by(TierID) %>%
  mutate(
    DatetimeRound = lubridate::as.numeric:round_date(DatetimeUTC,"15 minutes")
  )

# warum funktioniert es nicht?

head(ws_newyear)
view(ws_newyear)
summarise(ws_newyear)
```


Making Data comparable via unit = 1 day / 1 hour / 1 week if needed

+ deriving speed via summarise(speed_mean = mean(speed))

1. rounding dates
```{r}


# funktioniert!!!

# without Geometry
ws_newyear_speed %>%
  st_drop_geometry() %>%
  mutate(datetime_round = lubridate::round_date(as.POSIXct(DatetimeUTC),unit = "1 day")) %>%
  group_by(TierID, datetime_round) %>%
  summarise(speed_mean = mean(speed)) -> ws_newyear_speed_day

# for steplegth
ws_newyear_speed_day_geometry %>%
  st_drop_geometry() %>%
  mutate(datetime_round = lubridate::round_date(as.POSIXct(DatetimeUTC),unit = "1 day")) %>%
  group_by(TierID, datetime_round) %>%
  summarise(steplegth_mean = mean(steplength)) -> ws_newyear_steplength_day

view(ws_newyear_steplength_day)

# with Geometry
ws_newyear_speed %>%
  mutate(datetime_round = lubridate::round_date(as.POSIXct(DatetimeUTC),unit = "1 day")) %>%
  group_by(TierID, datetime_round, E, N) -> ws_newyear_speed_day_geometry

view(ws_newyear_speed_day_geometry)


# moving window approach
ws_newyear_speed_mean %>% 
  head(100) %>%
  mutate(rollmean = zoo::rollmean(speed_mean, 5, fill = NA, align = "center")) %>%
  ggplot(aes(datetime_round)) +
  geom_line(aes(y = speed_mean, colour = "speedmean")) +
  #geom_point(aes(y = speed_mean)) +
  geom_line(aes(y = rollmean, colour = "rollmean"))
  

#same as steplegth
ws_newyear_roll <- ws_newyear_speed_day_geometry %>%
  mutate(
    net_displacement = sqrt((E-lead(E, 20))^2+(N-lead(N, 20))^2)
  )


view(ws_newyear_roll)

# funktioniert nicht??
# funktioniert nicht??
# funktioniert nicht??

ggplot(ws_newyear_steplength_day, aes(datetime_round, steplength_mean, colour=TierID)) + geom_point()  
  


view(ws_newyear_roll)
view(ws_newyear)



```


Deriving Speed
```{r}
# task 1 ########################################################################

ws_newyear <- ws_newyear %>%
  mutate(timelag = as.numeric(difftime(lead(DatetimeUTC),DatetimeUTC,units = "mins")))

view(ws_newyear)

head(ws_newyear)

ggplot(ws_newyear, aes(DatetimeUTC,TierID)) +
  geom_line()

ggplot(ws_newyear, aes(timelag)) +
  geom_histogram(binwidth = 50) +
  lims(x = c(0,15000)) +
  scale_y_log10()


ws_newyear %>%
  ggplot(aes(DatetimeUTC,timelag, colour = TierID)) +
  geom_line() +
  geom_point()


# task 2 ########################################################################

ws_newyear <- ws_newyear %>%
  group_by(TierID) %>%
  mutate(
    steplength = sqrt((E-lead(E))^2+(N-lead(N))^2)
  )


ws_newyear_speed <- ws_newyear %>%
  group_by(TierID) %>%
  mutate(
    speed = steplength/timelag
  )

view(ws_newyear_speed)

# task 3 ########################################################################


ws_newyear_speed[seq(1, nrow(ws_newyear_speed),3), ]

ws_newyear_speed_3 <- ws_newyear_speed[seq(1, nrow(ws_newyear_speed),3), ]

ws_newyear_speed_6 <- ws_newyear_speed[seq(1, nrow(ws_newyear_speed),6), ]

ws_newyear_speed_9 <- ws_newyear_speed[seq(1, nrow(ws_newyear_speed),9), ]



ws_newyear_speed <- ws_newyear_speed %>%
  mutate(
    timelag = as.numeric(difftime(lead(DatetimeUTC),DatetimeUTC,units = "secs")),
    steplength = sqrt((E-lead(E))^2+(N-lead(N))^2),
    speed = steplength/timelag
  )

ws_newyear_speed_3 <- ws_newyear_speed_3 %>%
  mutate(
    timelag = as.numeric(difftime(lead(DatetimeUTC),DatetimeUTC,units = "secs")),
    steplength = sqrt((E-lead(E))^2+(N-lead(N))^2),
    speed = steplength/timelag
  )

ws_newyear_speed_6 <- ws_newyear_speed_6 %>%
  mutate(
    timelag = as.numeric(difftime(lead(DatetimeUTC),DatetimeUTC,units = "secs")),
    steplength = sqrt((E-lead(E))^2+(N-lead(N))^2),
    speed = steplength/timelag
  )


ws_newyear_speed_9 <- ws_newyear_speed_9 %>%
  mutate(
    timelag = as.numeric(difftime(lead(DatetimeUTC),DatetimeUTC,units = "secs")),
    steplength = sqrt((E-lead(E))^2+(N-lead(N))^2),
    speed = steplength/timelag
  )


ggplot() +
  geom_point(data = ws_newyear_speed, aes(E,N, colour = "1 minute"), alpha = 0.2) +
  geom_path(data = ws_newyear_speed, aes(E,N, colour = "1 minute"), alpha = 0.2) +
  geom_point(data = ws_newyear_speed_3, aes(E,N, colour = "3 minutes")) +
  geom_path(data = ws_newyear_speed_3, aes(E,N, colour = "3 minutes")) +
  labs(color="Trajectory", title = "Comparing original- with 3 minutes-resampled data")  +
  theme_minimal()

ggplot() +
  geom_point(data = caro, aes(E,N, colour = "1 minute"), alpha = 0.2) +
  geom_path(data = caro, aes(E,N, colour = "1 minute"), alpha = 0.2) +
  geom_point(data = caro_6, aes(E,N, colour = "6 minutes")) +
  geom_path(data = caro_6, aes(E,N, colour = "6 minutes")) +
  labs(color="Trajectory", title = "Comparing original- with 6 minutes-resampled data") +
  theme_minimal()

ggplot() +
  geom_point(data = fritz, aes(E,N, colour = "1 minute"), alpha = 0.2) +
  geom_path(data = fritz, aes(E,N, colour = "1 minute"), alpha = 0.2) +
  geom_point(data = fritz_9, aes(E,N, colour = "9 minutes")) +
  geom_path(data = fritz_9, aes(E,N, colour = "9 minutes"))+
  labs(color="Trajectory", title = "Comparing original- with 9 minutes-resampled data") +
  theme_minimal()

view(fritz_9)

ggplot() +
  geom_line(data = ws_newyear_speed, aes(DatetimeUTC,speed, colour = "1 minute")) +
  geom_line(data = ws_newyear_speed_3, aes(DatetimeUTC,speed, colour = "3 minutes")) +
  geom_line(data = ws_newyear_speed_6, aes(DatetimeUTC,speed, colour = "6 minutes")) +
  geom_line(data = ws_newyear_speed_9, aes(DatetimeUTC,speed, colour = "9 minutes")) +
  labs(x = "Time",y = "Speed (m/s)", title = "Comparing derived speed at different sampling intervals") +
  theme_minimal()



# task 4 ########################################################################

library(zoo)

example <- rnorm(10)
rollmean(example,k = 3,fill = NA,align = "left")
rollmean(example,k = 4,fill = NA,align = "left")



ws_summer_new <- ws_summer %>%
  mutate(
    speed3 = rollmean(speed,3,NA,align = "left"),
    speed6 = rollmean(speed,6,NA,align = "left"),
    speed9 = rollmean(speed,9,NA,align = "left")
  )

head(ws_summer_new)

ws_summer_new %>%
  ggplot() +
  geom_line(aes(DatetimeUTC,speed), colour = "#E41A1C") +
  geom_line(aes(DatetimeUTC,speed3), colour = "#377EB8") +
  geom_line(aes(DatetimeUTC,speed6), colour = "#4DAF4A") +
  geom_line(aes(DatetimeUTC,speed9), colour = "#984EA3")
```



Durchschnittsgeschwindigkeit errechnen!

```{r}

mean(fritz$speed)

library(dplyr)

fritz %>%
  group_by(DatetimeUTC = days(1)) %>%
  summarise_at(vars(col_to_aggregate), list(name = mean))

is.numeric(fritz$speed)


library(readr)
library(dplyr)
library(ggplot2)



fritz <- fritz %>%
  mutate(
    stepMean = rowMeans(                       
      cbind(                                   
        sqrt((lag(E,3)-E)^2+(lag(E,3)-E)^2),   
        sqrt((lag(E,2)-E)^2+(lag(E,2)-E)^2),   
        sqrt((lag(E,1)-E)^2+(lag(E,1)-E)^2),   
        sqrt((E-lead(E,1))^2+(E-lead(E,1))^2),  
        sqrt((E-lead(E,2))^2+(E-lead(E,2))^2),
        sqrt((E-lead(E,3))^2+(E-lead(E,3))^2)  
        )                                        
    )
  )

# Note: 
# We present here a slightly different approach as presented in the input:
# - cbind() creates a matrix with the same number of rows as the original dataframe
# - It has 6 columns, one for each Euclidean distance calculation
# - rowMeans() returns a single vector with the same number of rows as the original dataframe


# task 2 ########################################################################

summary(fritz$stepMean)

ggplot(fritz, aes(stepMean)) +
  geom_histogram(binwidth = 1) +
  geom_vline(xintercept = mean(fritz$stepMean,na.rm = TRUE))

fritz <- fritz %>%
  mutate(
    static = stepMean < mean(fritz$stepMean,na.rm = TRUE)
  ) 

view(fritz)

# task 3 ########################################################################

fritz %>%
  ggplot() +
  geom_path(aes(E,N), alpha = 0.5) +
  geom_point(aes(E,N,colour = static)) +
  theme_minimal() +
  coord_equal()




# task 4 ########################################################################

fritz <-fritz %>%
  mutate(
    segment_ID = rle_id(static)
  )

caro60_moves <- caro60 %>%
  filter(!static)


p1 <- ggplot(caro60_moves, aes(E, N, color = segment_ID)) +
  geom_point() +
  geom_path() +
  coord_equal() +
  theme(legend.position = "none") +
  labs(subtitle =  "All segments (uncleaned)")


p2 <- caro60_moves %>%
  group_by(segment_ID) %>%
  mutate(duration = as.integer(difftime(max(DatetimeUTC),min(DatetimeUTC),"mins"))) %>%
  filter(duration > 5) %>%
  ggplot(aes(E, N, color = segment_ID))+
  # geom_point(data = caro60, color = "black") +
  geom_point() +
  geom_path() +
  coord_equal() +
  theme(legend.position = "none") +
  labs(subtitle = "Long segments (removed segements <5 minutes)")


```


--> How many individuals were tracked?
--> For which timesequence do we have comparable Data? 
--> average intervals? --> Making it comparable

```{r}
ws_be_sf %>% 
  st_drop_geometry() %>% 
  group_by(TierID, TierName) %>% 
  summarise(pings = n(),
            start_time = min(DatetimeUTC), 
            end_time = max(DatetimeUTC),
            avg_interval = mean(timelag, na.rm = T),
            total_tracking_time = sum(timelag, na.rm = T)) %>% 
  mutate(tracking_time_days = days(day(seconds_to_period(total_tracking_time)))) 


```



Now lets create visualisations of the same information.
```{r}
ggplot(data = ws_be_sf, aes(x = DatetimeUTC, y = TierID)) +
  geom_line()

ws_be_sf %>% 
  filter(timelag < 15000) %>% 
  ggplot(data = ., aes(timelag), fill = TierID) +
    geom_bar(position=position_dodge()) + facet_wrap(~TierID)  #Need to log this

ws_be_sf %>% 
  filter(timelag < 15000) %>% 
  ggplot(data = ., aes(timelag), fill = TierID) +
    geom_bar() + scale_y_log10()  #Perfect

ggplot(data = ws_be_sf, aes(x = DatetimeUTC, y = timelag, color = TierID)) +
  geom_line()

ggplot(data = ws_be_sf, aes(x=TierID, y = timelag)) +
  geom_boxplot()
```




## Specifying temporal windows
Our sampling interval is 1 minute - if we take a temporal window of 6 minutes we use a window size of 6 positions. Therefore that's 3 plus and 3 minus.
```{r}
ws_summer %>% 
  mutate(
    nMinus3 = sqrt((lag(E,3)-E)^2 + (lag(N,3)-N)^2),
    nMinus2 = sqrt((lag(E,2)-E)^2+(lag(N,2)-N)^2),  
    nMinus1 = sqrt((lag(E,1)-E)^2+(lag(N,1)-N)^2),
    nPlus1  = sqrt((E-lead(E,1))^2+(N-lead(N,1))^2), 
    nPlus2  = sqrt((E-lead(E,2))^2+(N-lead(N,2))^2),  
    nPlus3  = sqrt((E-lead(E,3))^2+(N-lead(N,3))^2)  
) -> ws_summer_steps

view(ws_summer_steps)

ws_summer_steps %>% 
  rowwise() %>% 
  mutate(
    stepMean = mean(c(nMinus3, nMinus2, nMinus1, nPlus1, nPlus2, nPlus3))
  ) %>% 
  ungroup() -> ws_summer_steps
```

Group by TierName
Step_mean
```{r}

```


<!-- the following is just a placeholder text, remove it!-->
Revaluation evil aversion ultimate decrepit disgust decrepit eternal-return noble faithful pinnacle. Truth ascetic inexpedient decrepit free. Ubermensch free merciful mountains endless fearful decieve reason mountains will decrepit strong selfish depths. Overcome faith snare gains oneself transvaluation.




# Data exploration
```{r}
ws %>% 
  group_by("ruth") %>% 
  summarise(n = n())

summary("ruth")

str("ruth")

ggplot(ws) + geom_sf()
tm_shape(ws) + tm_dots(col = "ruth")

view(ws)

ggplot(ws_be_sf_steps) +
  geom_histogram(aes(stepMean), bins = 60) + geom_vline(xintercept = 4, color = "red")
summary(ws_be_sf_steps$stepMean)
``` 


# Visualisation of the spatio-temporal patterns
# Visualizing the percentage of samples in a given location
```{r}
ggplot(wildboar) +
  geom_polar(aes(rough_location))

#--> Excercise 5!!

``` 


# Visualization of activity patterns // maybe related to spatial context

First: Calculating Mean Steplengh
Second: Plotting with geom_tile 
y = TierName
x = mean hours of the day
fill = steplegth

```{r}
#Example:
  
  diamonds %>%
                     count(color, cut) %>%
                     ggplot(mapping = aes(x = color, y = cut)) +
                       geom_tile(mapping = aes(fill = n))


  ws_newyear_speed %>%
    count(time, location) %>%
    ggplot(mapping = aes(x = time, y = location)) +
    geom_tile(mapping = aes(speed))

fritz %>% 
  filter(DatetimeUTC >= as.Date("2014-12-02") & DatetimeUTC < as.Date("2014-12-03")) -> fritz_12_02

view(ws_newyear_steplength_day)

ws_newyear_steplength_day %>%
count(datetime_round, TierID) %>%
ggplot(mapping = aes(x = datetime_round, y = TierID)) +
geom_tile(mapping = aes(fill = steplength_mean))

# waruuum??

# Fehler in FUN(X[[i]], ...) : Objekt 'speed' nicht gefunden

view(fritz)

ggplot(data = fritz, aes(x = DatetimeUTC, y = timelag, color = TierID)) +
  geom_line()

ggplot(data = ws_newyear_speed, aes(x=TierID, y = speed)) +
  geom_boxplot()


``` 


2.calculating mean speed of wildboar
```{r}
ws_summer <- ws_be_sf %>%
  filter(month(DatetimeUTC) %in% 5:6)

view(ws_summer_speed)


ggplot(ws_summer_speed) +
  geom_histogram(aes(stepMean), bins = 60) + geom_vline(xintercept = 4, color = "red")
summary(ws_summer_speed$stepMean)

ggplot(ws_newyear_speed) +
  geom_boxplot(aes(speedMean), bins = 60 + geom_vline(xintercept = 4, color = "red"))

```


spatio-temporal patterns of all wild boar 
Objective: having a fully ranked behavioural pattern of all wildboars in a certain timeframe
Could be one Week 
```{r}

# task 1 ########################################################################

crop_fanel <- read_sf("Feldaufnahmen_Fanel.gpkg")

head(crop_fanel)

summary(crop_fanel)

unique(crop_fanel$Frucht)

st_crs(crop_fanel)

ggplot(crop_fanel) +
  geom_sf(aes(fill = Frucht))


# Task 2: Annotate Trajectories
Filter to summer
```{r}
ws %>% 
  filter(DatetimeUTC >= as.Date("2015-05-01") & DatetimeUTC < as.Date("2015-07-01")) -> ws_summer

ggplot() +
  geom_sf(data= fanel, aes(fill = Frucht)) +
  geom_sf(data = ws_summer) + theme_void() 
st_join(ws_summer, fanel) %>%
  mutate(round_DatetimeUTC = round_date(DatetimeUTC, unit = "hours"),
         hours = format(round_DatetimeUTC, "%H"))-> ws_annotate
```

# Task 3: Explore the annotated dataset
```{r}
ws_annotate %>% 
  group_by(Frucht, TierName) %>% 
  summarise(minTime = min(round_DatetimeUTC), maxTime = max(round_DatetimeUTC), n=n()) %>% 
  mutate(duration = as.numeric(difftime(maxTime, minTime, units="hours"))) %>% 
  ggplot(.) + geom_bar(aes(x = hours, fill = Frucht))
ws_annotate %>% 
  group_by(Frucht, TierName) %>% 
  mutate(duration = as.numeric(difftime(lead(DatetimeUTC),DatetimeUTC), units="hours")) -> t
ws_annotate %>% 
  ggplot(.) + geom_bar(aes(x = hours, fill = Frucht),
                       position = "fill") + theme_classic() + facet_wrap(~TierName) + coord_polar()
```

# Task 4: Raster Data
```{r}
library(tmap)
terra::rast("rawdata/vegetationshoehe_LFI.tif") -> vegetation
```

# Task 5: Extract Data from Raster
```{r}
terra::extract(vegetation, vect(wildschwein_BE)) %>% 
  cbind(wildschwein_BE, .) %>% 
  st_as_sf(.) -> wildschwein_BE
wildschwein_BE %>% select(geometry, vegetationshoehe_LFI) %>% 
ggplot() +
  geom_sf(data = wildschwein_BE, aes(color = vegetationshoehe_LFI)) -> gg
gg
plot_gg(gg)
ggplot() +
  geom_point(data=wildschwein_BE, aes(x=E, y = N, color = vegetationshoehe_LFI)) + coord_fixed() -> gg1
plot_gg(gg1)
```


